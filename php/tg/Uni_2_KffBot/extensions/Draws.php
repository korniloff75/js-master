<?php

class Draws extends Helper
{
	use UniConstruct;

	const
		FOLDER = __DIR__.'/../Game_2',
		BASE = self::FOLDER . '/base.json',
		IMG = '/assets/roullete.jpg';

	protected
		$draws;

	private
		$drawsOwner,
		$addSelf,
		$toAllParticipants;

	/**
	 * @param cmd - 'cmdName_opt1_opt2_...etc'
	 */
	public function __construct(UniKffBot &$UKB, ?array $cmd=null)
	{
		// parent::__construct();

		// *–ó–∞–ø—Ä–µ—Ç –∑–∞–ø—É—Å–∫–∞ –∏–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
		// if($UKB->chat_id === -1001305018802)
		// 	die;

		$this->setConstruct($UKB, $cmd)
			->init()
			->routerCmd();
			// ->saveCurData();

	} //* __construct


	private function init()
	{
		// $this->log->add('$this->BTNS=',null,[$this->BTNS]);

		$this->getCurData();

		$this->drawsOwner = isset($this->data['current draws']['owner'])
		&& $this->user_id === $this->data['current draws']['owner']['id'];
		// $this->drawsOwner = $this->UKB->getStatement()->statement['drawsOwner'];

		if(!$this->drawsOwner)
			$this->UKB->setStatement([
				'drawsOwner'=>0
			]);

		$this->data['change'] = 0;

		// $this->log->add(__METHOD__.' $this->data=',null,$this->data);

		return $this;
	} //* init


	protected function routerCmd($cmd=null)
	{
		$o = parent::routerCmd($cmd);

		$this->log->add(__METHOD__.' $o=',null,[$o]);

		$draws = &$this->data['current draws'];
		// $pumps = &$this->data['pumps'];

		if(!$o) switch ($cmd ?? $this->cmd[0]) {
			//*** –ù–æ–≤—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à ***
			case 'draws':
			case 'new draw':
				if(!empty($draws))
				{
					$o = $this->showMainMenu([
						'text' => "–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à, –ø–æ–∫–∞ –Ω–µ —Ä–∞–∑—ã–≥—Ä–∞–Ω –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç " . $this->showUsername($draws['owner']) . ". –ù–æ –≤—ã –º–æ–∂–µ—Ç–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º - /participate",
						'reply_markup'=> [
							'inline_keyboard'=>[[[
								'text' => self::CMD['Draws']['participate'],
								'callback_data'=> '/Draws/participate'
							]]]
						]
					]);
				break;
				}

				$o = [
					'text' => '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–∑–æ–≤ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ.',
					'reply_markup' => [
						"inline_keyboard" => [
							[
								['text' => 1, 'callback_data' => '/Draws/prizes_count__1'],
								['text' => 2, 'callback_data' => '/Draws/prizes_count__2'],
								['text' => 3, 'callback_data' => '/Draws/prizes_count__3'],
							],
				],],];

				$this->statement = $this->UKB->setStatement([
					'drawsOwner'=>1
				]);
				$this->log->add('new draw $this->statement[drawsOwner]=',null, [$this->statement['drawsOwner']]);
				break;

			case 'prizes_count':
				$this->log->add('prizes_count $this->drawsOwner=',null, [$this->drawsOwner]);
				$this->log->add('prizes_count $this->statement[drawsOwner]=',null, [$this->statement['drawsOwner']]);

				if( !$this->drawsOwner && !$this->statement['drawsOwner'] )
				{
					$o = $this->showMainMenu([
						'text'=> '–ú–µ–Ω—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–∑–æ–≤ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Å–ø–æ–Ω—Å–æ—Ä —Ä–æ–∑—ã–≥—Ä—ã—à–∞!',
					]);
					break;
				}

				$this->data['change']++;
				$draws = [
					'owner' => $this->cbn['from'],
					'prizes_count' => $this->cmd[1][0],
				];

				$this->statement = $this->UKB->setStatement([
					'drawsOwner'=>1
				]);

				$o = $this->showMainMenu([
					'text'=> '–†–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω.',
				]);

				$this->addSelf = 1;

				//! sendToAll
				// $this->sendToAll([
				$this->sendToChats([
					'text'=> "–°–æ–∑–¥–∞–Ω —Ä–æ–∑—ã–≥—Ä—ã—à –æ—Ç " . $this->showUsername($draws['owner']) . ". –°–ø–µ—à–∏—Ç–µ –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ!",
					'reply_markup'=> [
						'inline_keyboard'=>[[[
							'text' => self::CMD['Draws']['participate'],
							'callback_data'=> 'draws/participate'
						]]]
					]
				]);
				break;

			case 'cancel draw':
				if(!$this->is_owner && empty($this->statement['drawsOwner']))
				{
					$o= ['text'=>'–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à'];
					break;
				}

				$o= $this->showMainMenu(['text'=>"–†–æ–∑—ã–≥—Ä—ã—à –æ—Ç " . $this->showUsername($draws['owner']) . " –±—ã–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω"]);
				//! sendToChats
				$this->sendToChats($o);

				unset($draws, $this->data['current draws']);
				$this->data['change']++;

				die;
				break;

			case 'show participants':
				$o = $this->showParticipants();
				$o['text'] .= "\n<a href='{$this->urlDIR}".self::IMG."'>&#8205;</a>";
				break;

			//* –†–æ–∑—ã–≥—Ä—ã—à
			case 'play draw':
				$this->statement = $this->UKB->setStatement([
					'drawsOwner'=>0
				]);

				if(!count($draws['participants']))
				{
					$o = $this->showMainMenu([
						'text' => "–ö–æ–≥–æ —Ä–∞–∑—ã–≥—Ä—ã–≤–∞—Ç—å —Å–æ–±–∏—Ä–∞–µ–º—Å—è, —Ç–æ–≤–∞–≥–∏—Å—á?\n\n–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à!",
					]);
					break;
				}

				shuffle($draws['participants']);
				$winners = []; $winStr = '';

				for($i=0; $i < $draws['prizes_count']; $i++)
				{
					if(empty($draws['participants'][$i]))
						break;

					$winners[] = $draws['participants'][$i];
					$winStr .= $this->showUsername($winners[$i],'tag');
				}

				$o = $this->showMainMenu([
					'text' => "<u>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏:</u>\n\n$winStr\n<a href='{$this->urlDIR}".self::IMG."'>&#8205;</a>",
				]);

				$o = array_merge_recursive($this->showParticipants(), $o);
				//! sendToChats
				$this->sendToChats($o);
				unset($draws, $this->data['current draws']);
				$this->data['change']++;
				die;
				break;

			//* –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
			case 'participate':
				$count = count($draws['participants']);

				if(in_array($this->cbn['from'], $draws['participants']))
				{
					$o = $this->showMainMenu([
						'text' => "–¢—ã —É–∂–µ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à. –ö–æ–Ω—á–∞–π —Å–µ—Ä–≤–µ—Ä –º—É—á–∞—Ç—å, –∞ —Ç–æ - –∑–∞–±–∞–Ω—é –Ω–∞—Ö!\n\n–ê –≤–æ–æ–±—â–µ —É–∂–µ $count —á–µ–ª. –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ."
					]);
					break;
				}
				elseif(
					!empty($owner = $draws['owner'])
				) {
					$this->data['change']++;
					$draws['participants'][]= $this->cbn['from'];
					$count++;

					$o = [
						'text' => "–£—á–∞—Å—Ç–Ω–∏–∫ " . $this->showUsername($this->cbn['from']) . " –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –æ—Ç {$owner['first_name']}.\n–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ {$count} —á–µ–ª.",
					];
					$this->sendToOwner = 1;
				}
				else $o = [
					'text' => '–î–ª—è –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –≤ –Ω–∞—Å—Ç–æ—è—â–∏–π –º–æ–º–µ–Ω—Ç. –ù–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.',
					'reply_markup'=> [
						'inline_keyboard'=>[[[
							'text' => self::CMD['Draws']['new draw'],
							'callback_data'=> 'Draws/new draw'
						]]]
					]
				];
				break;

			case 'start':
			case 'general':
				$draw= [
					/* 'text' => isset($draws['owner'])
					? "–°–æ–∑–¥–∞–Ω —Ä–æ–∑—ã–≥—Ä—ã—à –æ—Ç {$draws['owner']['first_name']}. –°–ø–µ—à–∏—Ç–µ –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ!"
					: "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –Ω–µ—Ç. –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π." */
				];

				$o = $this->showMainMenu($draw);
				break;

			default: die;
		} //*switch


		//note –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
		if($o)
		{
			$this->log->add(__METHOD__.': –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞',null,['$this->is_owner'=>$this->is_owner]);
			/* if(is_null($this->is_owner))
				$this->log->add(__METHOD__.' is_null $this->is_owner this=',null,[$this]); */

			//* –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞
			if(
				!empty($draws) && (
					$this->statement['drawsOwner']
					|| $this->is_owner
				)
			)
			{
				$keyboard = [
					['text' => self::CMD['Draws']['play draw']],
					['text' => self::CMD['Draws']['show participants']],
					['text' => self::CMD['Draws']['cancel draw']],
				];
			}
			//* –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
			elseif(
				!empty($draws) && !$this->drawsOwner
			)
			{
				if(!in_array($this->cbn['from'], $draws['participants']))
					$keyboard = [['text' => self::CMD['Draws']['participate']]];
			}
			//* –°–æ–∑–¥–∞—Ç—å
			else
				// $keyboard = [['text' => self::CMD['Draws']['new draw']]];
				// *–£–±–∏—Ä–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–∏
				$keyboard = [];

			//* –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
			if(
				!empty($keyboard) && !empty($this->cmd[0])
				// && !in_array($this->cmd[0], ['general','start'])
				&& in_array($this->cmd[0], ['advanced'])
			)
				$o['reply_markup']['keyboard'] = array_merge_recursive($o['reply_markup']['keyboard'], [$keyboard]);

			//* Send
			$o['chat_id']= $this->user_id;
			$this->apiRequest($o);

			//* –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
			if(!empty($this->addSelf))
			{
				$this->addSelf = null;
				return $this->routerCmd('participate');
			}

			//* –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü—É —Ä–æ–∑—ã–≥—Ä—ã—à–∞
			if(!empty($this->sendToOwner) && !$this->statement['drawsOwner'])
			{
				$this->sendToOwner = null;
				$o['chat_id'] = $draws['owner']['id'];
				$this->apiRequest($o);
			}
		}

		return $this;
	} //* routerCmd üí°


	private function showParticipants()
	:array
	{
		$draws = &$this->data['current draws'];
		$ps = '';
		foreach($draws['participants'] as $p)
		{
			$ps .= $this->showUsername($p);
		}
		return [
			'text' => "<u>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å:</u> " . count($draws['participants']) . " —á–µ–ª.\n\n$ps\n<a href='{$this->urlDIR}".self::IMG."'>&#8205;</a>"
		];
	}

} //* Draws
